<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "X-UA-Compatible" content = "IE = edge" charset = "UTF-8"/> 
		<title>TEST</title>
		<!-- <link rel = "stylesheet" href = "../src/main/webapp/pages/css/wanma.css"/> -->
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/default/easyui.css"/>
		<!-- <link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/icon.css"/> -->
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/tssJS/tssJS.all.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.easyui.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/easyui-lang-zh_CN.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/echarts/echarts-3.1.5.js"></script>
		<!-- <script type = "text/javascript" src = "../src/main/webapp/more/bi_template/echart.js"></script> -->
		<!-- <script type = "text/javascript" src = "../src/main/webapp/more/bi_template/common.js"></script> -->
		<!-- <script type = "text/javascript" src = "../src/main/webapp/pages/js/common.js"></script> -->
		<script type = "text/javascript">
			var data, data1;
			
			var DATA_URL = "http://10.45.10.216:8080/tss/data/json/2150";
			
			
			var method = "POST";
			var param1 = {"param1": "按区域","param2": "-1" };
			var param2 = {"param1": "按分拨","param2": "-1" };
			

			
			$(function(){
			 
				tssJS.ajax({
				url: DATA_URL,
				params: param1,
				method: method,
				waiting: true,
				ondata: function(){
					data =  this.getResponseJSON();
					datatree(data);
					}
				});	
				
				tssJS.ajax({
				url: DATA_URL,
				params: param2,
				method: method,
				waiting: true,
				ondata: function(){
					data1 =  this.getResponseJSON();
					datatree1(data1);
					}
				});	
					
			});

			
			function  datatree(data){
				var json = {}, rows = [], footer = [];
				var reglist = [], routelist = [], typelist = [];
				var regid = {}, typeid = {}, routeid = {} ;//包含名称和id
				var s = 1, t = 1, k = 1, route;
				var area_in_c = {}, area_in_l = {}, area_out_c = {}, area_out_l = {};
				var route_out_c = {}, route_out_l = {},reg_c= {}, reg_l = {}, all_c = 0, all_l = 0;
				
				//id初始化
				for(var i = 0; i < data.length; i++){
					if(!typelist.contains(data[i]["type"])){
							typelist.push(data[i]["type"]);
							typeid[data[i]["type"]] = t;
							t++
						};
					if(data[i]["to_reg"] == null){
						if(!reglist.contains(data[i]["in_reg"])){
							reglist.push(data[i]["in_reg"]);
							regid[data[i]["in_reg"]] = s;
							area_in_c[data[i]["in_reg"]] = 0;
							area_in_l[data[i]["in_reg"]] = 0;
							area_out_c[data[i]["in_reg"]] = 0;
							area_out_l[data[i]["in_reg"]] = 0;
							reg_c[data[i]["in_reg"]] = 0;
							reg_l[data[i]["in_reg"]] = 0;
							s++;
						};
					}else{
						route = data[i]["in_reg"] + "→" + data[i]["to_reg"];
						if(!routelist.contains(route)){
							routelist.push(route);
							routeid[route] = k;
							route_out_c[route] = 0;
							route_out_l[route] = 0;
							k++;
						};
					};
				}
				
				//最后子节点赋值，按车型，并计算上一层值
				for(var i = 0; i < data.length; i++){
					route = data[i]["in_reg"] + "→" + data[i]["to_reg"];
					var reg = data[i]["in_reg"], type = data[i]["type"], capacity = data[i]["capacity"], line = data[i]["line"];
					if(data[i]["to_reg"] == null){
						rows.push({"id":regid[reg]*100+10+typeid[type], "_parentId":regid[reg]*10+1, "name":type, "capacity":capacity, "line":line});
						area_in_c[reg] += capacity;
						area_in_l[reg] += line;
					}else{
						rows.push({"id":regid[reg]*10000+2000+routeid[route]*10+typeid[type], "_parentId":regid[reg]*1000+200+routeid[route], "name":type, "capacity":capacity, "line":line});
						route_out_c[route] += capacity;
						route_out_l[route] += line;
					};
				}
				//区域外出发区域到目的区域
				for(var key in route_out_c){
					var reg = key.substring(0,4);
					rows.push({"id":regid[reg]*1000+200+routeid[key], "_parentId":regid[reg]*100+20, "name":key, "capacity":route_out_c[key], "line":route_out_l[key], "state":"closed"});
					area_out_c[reg] += route_out_c[key];
					area_out_l[reg] +=route_out_l[key];
				}
				//区域内外
				for(var key in area_in_c){
						rows.push({"id":regid[key]*10+1, "_parentId":regid[key], "name":"区域内", "capacity":area_in_c[key], "line":area_in_l[key], "state":"closed"});
						rows.push({"id":regid[key]*100+20, "_parentId":regid[key], "name":"区域外", "capacity":area_out_c[key], "line":area_out_l[key], "state":"closed"});
						reg_c[key] += area_in_c[key] + area_out_c[key];
						reg_l[key] += area_in_l[key] + area_out_l[key];
						
					};
				//第一层，每个区域累加
				for(var key in reg_c){
					rows.push({"id":regid[key],"name":key, "capacity":Math.round(reg_c[key]*100)/100, "line":reg_l[key], "state":"closed"});
					all_c += reg_c[key];
					all_l += reg_l[key];
				};
				
				
				footer.push({"name": "全网", "capacity": all_c, "line": all_l});
				json["rows"]= rows;
				json["footer"] = footer;
				json["total"] = rows.length;
				
			$("#tree").treegrid({
				idField:'id',
				treeField:'name',
				width: 700,
				height: 500,
				//rownumbers: true,
				showFooter: true,
				animate: true,
				data: json
			})
			
			
				
		};
		
		
		
		function datatree1(data1){
			var json = {}, rows = [], footer = [];
			var reglist = [], centerlist = [], typelist = [];
			var regid = {}, centerid = {}, typeid = {};
			var k = 1, s = 1, t = 1;
			var center_a = [], reg_a = [], all = [];
			var reg_to_center = [];//分拨和区域的从属关系
			
			
			//id初始化
			$.each(data1, function(i, item){
				if(!reglist.contains(item.reg)){
					var center_to_reg[item.reg] = []; //center放到对应的reg中
					reglist.push(item.reg);
					regid[item.reg] = k;
					reg_a[item.reg]["capacity"] = 0;
					reg_a[item.reg]["line"] = 0;
					k++;
				};
				if(!centerlist.contains(item.center)){
					centerlist.push(item.center);
					centerid[item.center] = s;
					center_a[item.center]["capacity"] = 0;
					center_a[item.center]["line"] = 0;
					s++;
				};
				if(!typelist.contains(item.type)){
					typelist.push(item.type);
					typeid[item.type] = t;
					t++;
				};
				
			});
			
			
			$.each(data1, function(i, item){
				var reg = item.reg, center = item.center, type = item.type;
				rows.push({"id":regid[reg]*10000+centerid[center]*10+typeid[type], "_parentId":regid[reg]*1000+centerid[center], "name":type, "capacity": item.capacity, "line":item.line});
				center_a[center]["capacity"] += item.capacity;
				center_a[center]["line"] += item.line;
				if(!center_to_reg[reg].contains(center)){
					center_to_reg[reg].push(center);
				};
			});
			
			for(var key in center_to_reg){
				for(var center in center_reg[key]){
					rows.push({"id":regid[key]*1000+centerid[center], "_parentId":regid[key], "name":center, "capacity": center_a[center]["capacity"], "line":center_a[center]["line"], "state": "closed"});
					reg_a[key]["capacity"] += center_a[center]["capacity"];
					reg_a[key]["line"] += center_a[center]["line"];
				};
				rows.push({"id":regid[key], "name":key, "capacity": reg_a[key]["capacity"], "line":reg_a[key]["line"], "state": "closed"});
				all["capacity"] += reg_a[key]["capacity"];
				all["line"] += reg_a[key]["line"];
			};
			
			footer.push({"name": "全网", "capacity": all["capacity"], "line": all["line"]});
			json["rows"]= rows;
			son["footer"] = footer;
			json["total"] = rows.length;
			
			$("#tree").treegrid({
				idField:'id',
				treeField:'name',
				width: 700,
				height: 500,
				//rownumbers: true,
				showFooter: true,
				animate: true,
				data: json
			});	
		};
		
			
			
		</script>
	</head>
	<body>
		<div>
			<table id = "tree" style = "width:100%; height:100%">
				<thead>
					<tr>
						<th data-options = "field: 'name'" width = "40%">名称</th>
						<th data-options = "field: 'line'" width = "30%">车线</th>
						<th data-options = "field: 'capacity'" width = "30%">运力</th>
					</tr>
				</thead>
			</table>
		</div>
	</body>
</html>